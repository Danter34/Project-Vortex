2025-10-17 22:03:25.551 +07:00 [INF] Request starting HTTP/1.1 POST https://localhost:7161/api/Order/create - application/json; charset=utf-8 101
2025-10-17 22:03:25.561 +07:00 [INF] Executing endpoint 'Vortex_API.Controllers.OrderController.CreateOrder (Vortex_API)'
2025-10-17 22:03:25.565 +07:00 [INF] Route matched with {action = "CreateOrder", controller = "Order"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] CreateOrder(Vortex_API.Model.DTO.OrderDTO) on controller Vortex_API.Controllers.OrderController (Vortex_API).
2025-10-17 22:03:25.573 +07:00 [INF] User d96541fd-a475-4304-b4a5-f34d39e49887 is creating an order.
2025-10-17 22:03:25.588 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@__userId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[Id], [t].[UserId], [t0].[Id], [t0].[CartId], [t0].[ProductId], [t0].[Quantity], [t0].[Id0], [t0].[AverageRating], [t0].[CategoryId], [t0].[CreatedAt], [t0].[Description], [t0].[IsHot], [t0].[IsNew], [t0].[Price], [t0].[StockQuantity], [t0].[Title]
FROM (
    SELECT TOP(1) [c].[Id], [c].[UserId]
    FROM [Carts] AS [c]
    WHERE [c].[UserId] = @__userId_0
) AS [t]
LEFT JOIN (
    SELECT [c0].[Id], [c0].[CartId], [c0].[ProductId], [c0].[Quantity], [p].[Id] AS [Id0], [p].[AverageRating], [p].[CategoryId], [p].[CreatedAt], [p].[Description], [p].[IsHot], [p].[IsNew], [p].[Price], [p].[StockQuantity], [p].[Title]
    FROM [CartItems] AS [c0]
    INNER JOIN [Products] AS [p] ON [c0].[ProductId] = [p].[Id]
) AS [t0] ON [t].[Id] = [t0].[CartId]
ORDER BY [t].[Id], [t0].[Id]
2025-10-17 22:03:25.631 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@p0='?' (DbType = DateTime2), @p1='?' (Size = 200), @p2='?' (DbType = Int32), @p3='?' (Size = 500), @p4='?' (Size = 4000), @p5='?' (Precision = 18) (Scale = 2) (DbType = Decimal), @p6='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Orders] ([CreatedAt], [Name], [Phone], [ShippingAddress], [Status], [TotalAmount], [UserId])
OUTPUT INSERTED.[Id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6);
2025-10-17 22:03:25.639 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@p7='?' (DbType = Int32), @p8='?' (DbType = Int32), @p9='?' (DbType = Int32), @p10='?' (Precision = 18) (Scale = 2) (DbType = Decimal)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [OrderItems] ([OrderId], [ProductId], [Quantity], [UnitPrice])
OUTPUT INSERTED.[Id]
VALUES (@p7, @p8, @p9, @p10);
2025-10-17 22:03:25.657 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__userId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT [t].[Id], [t].[UserId], [t0].[Id], [t0].[CartId], [t0].[ProductId], [t0].[Quantity], [t0].[Id0], [t0].[AverageRating], [t0].[CategoryId], [t0].[CreatedAt], [t0].[Description], [t0].[IsHot], [t0].[IsNew], [t0].[Price], [t0].[StockQuantity], [t0].[Title]
FROM (
    SELECT TOP(1) [c].[Id], [c].[UserId]
    FROM [Carts] AS [c]
    WHERE [c].[UserId] = @__userId_0
) AS [t]
LEFT JOIN (
    SELECT [c0].[Id], [c0].[CartId], [c0].[ProductId], [c0].[Quantity], [p].[Id] AS [Id0], [p].[AverageRating], [p].[CategoryId], [p].[CreatedAt], [p].[Description], [p].[IsHot], [p].[IsNew], [p].[Price], [p].[StockQuantity], [p].[Title]
    FROM [CartItems] AS [c0]
    INNER JOIN [Products] AS [p] ON [c0].[ProductId] = [p].[Id]
) AS [t0] ON [t].[Id] = [t0].[CartId]
ORDER BY [t].[Id], [t0].[Id]
2025-10-17 22:03:25.672 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@p0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
DELETE FROM [CartItems]
OUTPUT 1
WHERE [Id] = @p0;
2025-10-17 22:03:25.677 +07:00 [INF] Order 38 created successfully for user d96541fd-a475-4304-b4a5-f34d39e49887.
2025-10-17 22:03:25.678 +07:00 [INF] Executing OkObjectResult, writing value of type 'Vortex_API.Model.Domain.Order'.
2025-10-17 22:03:25.682 +07:00 [INF] Executed action Vortex_API.Controllers.OrderController.CreateOrder (Vortex_API) in 115.7723ms
2025-10-17 22:03:25.683 +07:00 [INF] Executed endpoint 'Vortex_API.Controllers.OrderController.CreateOrder (Vortex_API)'
2025-10-17 22:03:25.683 +07:00 [INF] Request finished HTTP/1.1 POST https://localhost:7161/api/Order/create - 200 null application/json; charset=utf-8 132.3754ms
2025-10-17 22:03:25.702 +07:00 [INF] Request starting HTTP/1.1 POST https://localhost:7161/api/Payment/create-momo - application/json; charset=utf-8 14
2025-10-17 22:03:25.704 +07:00 [INF] Executing endpoint 'Vortex_API.Controllers.PaymentController.CreateMomoPayment (Vortex_API)'
2025-10-17 22:03:25.707 +07:00 [INF] Route matched with {action = "CreateMomoPayment", controller = "Payment"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] CreateMomoPayment(Vortex_API.Model.DTO.PaymentRequest) on controller Vortex_API.Controllers.PaymentController (Vortex_API).
2025-10-17 22:03:25.710 +07:00 [INF] Creating MoMo payment for OrderId: 38
2025-10-17 22:03:25.734 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__dto_OrderId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [o].[Id], [o].[CreatedAt], [o].[Name], [o].[Phone], [o].[ShippingAddress], [o].[Status], [o].[TotalAmount], [o].[UserId]
FROM [Orders] AS [o]
WHERE [o].[Id] = @__dto_OrderId_0
2025-10-17 22:03:26.139 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@p0='?' (Precision = 18) (Scale = 2) (DbType = Decimal), @p1='?' (DbType = DateTime2), @p2='?' (Size = 4000), @p3='?' (DbType = Int32), @p4='?' (Size = 4000), @p5='?' (Size = 4000), @p6='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Payments] ([Amount], [CreatedAt], [MomoOrderId], [OrderId], [PayUrl], [PaymentMethod], [Status])
OUTPUT INSERTED.[Id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6);
2025-10-17 22:03:26.143 +07:00 [INF] MoMo payment creation result for OrderId 38: Vortex_API.Model.DTO.PaymentResponse
2025-10-17 22:03:26.144 +07:00 [INF] Executing OkObjectResult, writing value of type 'Vortex_API.Model.DTO.PaymentResponse'.
2025-10-17 22:03:26.146 +07:00 [INF] Executed action Vortex_API.Controllers.PaymentController.CreateMomoPayment (Vortex_API) in 437.7443ms
2025-10-17 22:03:26.147 +07:00 [INF] Executed endpoint 'Vortex_API.Controllers.PaymentController.CreateMomoPayment (Vortex_API)'
2025-10-17 22:03:26.148 +07:00 [INF] Request finished HTTP/1.1 POST https://localhost:7161/api/Payment/create-momo - 200 null application/json; charset=utf-8 445.698ms
2025-10-17 22:03:55.871 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[Id], [p].[Amount], [p].[CreatedAt], [p].[MomoOrderId], [p].[OrderId], [p].[PayUrl], [p].[PaymentMethod], [p].[Status], [o].[Id], [o].[CreatedAt], [o].[Name], [o].[Phone], [o].[ShippingAddress], [o].[Status], [o].[TotalAmount], [o].[UserId]
FROM [Payments] AS [p]
INNER JOIN [Orders] AS [o] ON [p].[OrderId] = [o].[Id]
WHERE [p].[Status] IN (N'Đang xử lý', N'Thanh toán thất bại')
